<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Payment Methods - DEEPEND Entertainment</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="assets/fontawesome/all.css" rel="stylesheet">
    <link href="styles.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        body { background: linear-gradient(135deg, #2a1818 0%, #18181b 100%); color: #fff; font-family: 'Roboto', sans-serif; min-height: 100vh; }
        .payment-container { max-width: 440px; margin: 48px auto; background: rgba(34,20,20,0.7); border-radius: 22px; box-shadow: 0 8px 32px rgba(255,59,48,0.18); padding: 2.7rem 2.2rem; backdrop-filter: blur(18px); border: 1.5px solid rgba(255,59,48,0.13); position: relative; }
        .payment-title { font-size: 1.7rem; font-weight: 700; margin-bottom: 1.7rem; display: flex; align-items: center; gap: 0.7rem; letter-spacing: 0.5px; }
        .payment-title i { color: #FF3B30; font-size: 1.5rem; }
        .back-link { color: #fff; text-decoration: none; font-size: 1.13rem; margin-bottom: 2.2rem; display: inline-block; transition: color 0.2s; }
        .back-link i { margin-right: 0.5rem; }
        .back-link:hover { color: #FF3B30; }
        .card-list { margin-bottom: 2.2rem; }
        .card-item { background: rgba(255,59,48,0.10); border: 1.5px solid rgba(255,59,48,0.18); border-radius: 14px; padding: 1.1rem 1.2rem; display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem; box-shadow: 0 2px 12px rgba(255,59,48,0.10); }
        .card-info { display: flex; align-items: center; gap: 1rem; }
        .card-icon { background: linear-gradient(135deg, #FF3B30, #FF6B6B); color: #fff; border-radius: 8px; width: 38px; height: 38px; display: flex; align-items: center; justify-content: center; font-size: 1.3rem; }
        .card-number { font-size: 1.08rem; font-weight: 500; letter-spacing: 1.2px; }
        .card-actions button { background: none; border: none; color: #fff; font-size: 1.2rem; margin-left: 0.7rem; cursor: pointer; transition: color 0.2s; }
        .card-actions button.edit:hover { color: #43e97b; }
        .card-actions button.delete:hover { color: #FF3B30; }
        .add-card-section { background: rgba(255,59,48,0.08); border: 1.5px solid rgba(255,59,48,0.13); border-radius: 14px; padding: 1.3rem 1.2rem; text-align: center; }
        .add-card-title { color: #FF3B30; font-weight: 600; margin-bottom: 0.7rem; font-size: 1.08rem; }
        .add-card-form { display: flex; flex-direction: column; gap: 1rem; align-items: center; }
        .add-card-form input { width: 100%; max-width: 260px; padding: 0.6rem; border-radius: 8px; border: none; font-size: 1.05rem; background: #2a1818; color: #fff; }
        .add-card-btn { background: linear-gradient(135deg, #FF3B30, #FF6B6B); color: #fff; border: none; border-radius: 8px; padding: 0.6rem 1.3rem; font-size: 1.07rem; font-weight: 600; margin-top: 0.2rem; transition: box-shadow 0.2s, transform 0.15s; box-shadow: 0 2px 12px rgba(255,59,48,0.10); }
        .add-card-btn:hover { box-shadow: 0 4px 18px rgba(255,59,48,0.18); transform: translateY(-2px) scale(1.04); }
        .no-cards { color: #aaa; font-size: 1.01rem; margin-bottom: 1.2rem; }
        @media (max-width: 600px) { .payment-container { padding: 1.2rem 0.5rem; } }
        .confirm-modal-bg { position: fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.6); z-index:3000; display:flex; align-items:center; justify-content:center; animation: fadeInBg 0.3s; }
        .confirm-modal { background:rgba(35,20,20,0.98); border-radius:16px; padding:2.2rem 1.5rem; min-width:320px; max-width:92vw; box-shadow:0 8px 32px rgba(255,59,48,0.10); color:#fff; text-align:center; animation: popIn 0.25s; }
        .confirm-modal button { margin: 0 0.5rem; border-radius:8px; border:none; padding:0.5rem 1.2rem; font-weight:600; font-size:1rem; }
        .confirm-modal .yes { background:linear-gradient(135deg,#FF3B30,#FF6B6B); color:#fff; }
        .confirm-modal .no { background:#444; color:#fff; }
        @keyframes fadeInBg { from { opacity: 0; } to { opacity: 1; } }
        @keyframes popIn { from { transform: scale(0.92); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body>
    <div class="payment-container">
        <a href="profile.html" class="back-link"><i class="fa-regular fa-arrow-left"></i>Back to Profile</a>
        <div class="payment-title"><i class="fa-regular fa-credit-card"></i> Payment Methods</div>
        <div class="card-list" id="cardList"></div>
        <div class="add-card-section">
            <div class="add-card-title">Add New Card</div>
            <form class="add-card-form" id="addCardForm">
                <input type="text" id="cardNumber" maxlength="19" placeholder="Card Number (**** **** **** 1234)" required pattern="[0-9 ]{15,19}">
                <input type="text" id="cardName" maxlength="24" placeholder="Name on Card" required>
                <input type="text" id="cardExpiry" maxlength="5" placeholder="MM/YY" required pattern="[0-9]{2}/[0-9]{2}">
                <button type="submit" class="add-card-btn"><i class="fa-regular fa-plus"></i> Add Card</button>
            </form>
        </div>
    </div>
    <script src="assets/fontawesome/all.js"></script>
    <script type="module">
        import { SUPABASE_URL, SUPABASE_ANON_KEY } from './supabase/config.js';

        const supabase = axios.create({
            baseURL: `${SUPABASE_URL}/rest/v1`,
            headers: {
                'apikey': SUPABASE_ANON_KEY,
                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                'Content-Type': 'application/json',
                'Prefer': 'return=minimal'
            }
        });

        async function renderCards() {
            const cardList = document.getElementById('cardList');
            const userId = localStorage.getItem('deepend_user_id'); // Get logged-in user ID

            if (!userId) {
                cardList.innerHTML = '<div class="no-cards">Please log in to manage payment methods.</div>';
                return;
            }

            try {
                const { data: cards, error } = await supabase.from('payment_methods').select('*').eq('user_id', userId);
                if (error) throw error;

                if (cards.length === 0) {
                    cardList.innerHTML = '<div class="no-cards">No payment methods yet.</div>';
                    return;
                }
                cardList.innerHTML = '';
                cards.forEach((card) => {
                    cardList.innerHTML += `
                        <div class="card-item">
                            <div class="card-info">
                                <div class="card-icon"><i class="fa-regular fa-credit-card"></i></div>
                                <div>
                                    <div class="card-number">**** **** **** ${card.last_four_digits}</div>
                                    <div style="font-size:0.97em;color:#bbb;">${card.card_type} &bull; ${card.expiry_date}</div>
                                </div>
                            </div>
                            <div class="card-actions">
                                <button class="edit" title="Edit" data-id="${card.id}"><i class="fa-regular fa-pen"></i></button>
                                <button class="delete" title="Delete" data-id="${card.id}"><i class="fa-regular fa-trash"></i></button>
                            </div>
                        </div>
                    `;
                });
            } catch (error) {
                console.error('Error fetching payment methods:', error.message);
                cardList.innerHTML = '<div class="no-cards text-danger">Error loading payment methods.</div>';
            }
        }
            if (cards.length === 0) {
                cardList.innerHTML = '<div class="no-cards">No payment methods yet.</div>';
                return;
            }
            cardList.innerHTML = '';
            cards.forEach((card, i) => {
                cardList.innerHTML += `
                    <div class="card-item">
                        <div class="card-info">
                            <div class="card-icon"><i class="fa-regular fa-credit-card"></i></div>
                            <div>
                                <div class="card-number">${card.number}</div>
                                <div style="font-size:0.97em;color:#bbb;">${card.name} &bull; ${card.expiry}</div>
                            </div>
                        </div>
                        <div class="card-actions">
                            <button class="edit" title="Edit" onclick="editCard(${i})"><i class="fa-regular fa-pen"></i></button>
                            <button class="delete" title="Delete" onclick="deleteCard(${i})"><i class="fa-regular fa-trash"></i></button>
                        </div>
                    </div>
                `;
            });
        }
        async function editCard(cardId) {
            const userId = localStorage.getItem('deepend_user_id');
            if (!userId) {
                alert('Please log in to edit payment methods.');
                return;
            }

            try {
                const { data: cards, error } = await supabase.from('payment_methods').select('*').eq('id', cardId).eq('user_id', userId);
                if (error) throw error;
                if (cards.length === 0) {
                    alert('Card not found or you do not have permission to edit it.');
                    return;
                }
                const card = cards[0];

                const modalBg = document.createElement('div');
                modalBg.className = 'confirm-modal-bg';
                modalBg.innerHTML = `
                    <div class='confirm-modal' style='min-width:320px;'>
                        <h5 style='color:#FF3B30;'><i class='fa-regular fa-pen'></i> Edit Card</h5>
                        <input type='text' id='editCardNumber' value='${card.last_four_digits}' maxlength='4' placeholder='Last 4 digits' style='width:90%;margin-bottom:0.7rem;padding:0.5rem;border-radius:8px;border:none;background:#2a1818;color:#fff;'>
                        <input type='text' id='editCardType' value='${card.card_type}' maxlength='24' placeholder='Card Type (e.g., Visa, Mastercard)' style='width:90%;margin-bottom:0.7rem;padding:0.5rem;border-radius:8px;border:none;background:#2a1818;color:#fff;'>
                        <input type='text' id='editCardExpiry' value='${card.expiry_date}' maxlength='5' placeholder='MM/YY' style='width:90%;margin-bottom:0.7rem;padding:0.5rem;border-radius:8px;border:none;background:#2a1818;color:#fff;'>
                        <div style='margin-top:1.2rem;'>
                            <button class='yes' style='background:linear-gradient(135deg,#FF3B30,#FF6B6B);'>Save</button>
                            <button class='no'>Cancel</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modalBg);
                modalBg.querySelector('.no').onclick = () => modalBg.remove();
                modalBg.querySelector('.yes').onclick = async function() {
                    const updatedCard = {
                        last_four_digits: document.getElementById('editCardNumber').value.trim(),
                        card_type: document.getElementById('editCardType').value.trim(),
                        expiry_date: document.getElementById('editCardExpiry').value.trim()
                    };

                    try {
                        const { error: updateError } = await supabase.from('payment_methods').update(updatedCard).eq('id', cardId).eq('user_id', userId);
                        if (updateError) throw updateError;
                        alert('Card updated successfully!');
                        modalBg.remove();
                        renderCards();
                    } catch (updateError) {
                        console.error('Error updating card:', updateError.message);
                        alert('Failed to update card. Please try again.');
                    }
                };
            } catch (error) {
                console.error('Error fetching card for edit:', error.message);
                alert('Failed to load card for editing.');
            }
        }
        function deleteCard(idx) {
            let cards = JSON.parse(localStorage.getItem('deepend_cards') || '[]');
            cards.splice(idx, 1);
            localStorage.setItem('deepend_cards', JSON.stringify(cards));
            renderCards();
        }
        document.getElementById('addCardForm').onsubmit = function(e) {
            e.preventDefault();
            let cards = JSON.parse(localStorage.getItem('deepend_cards') || '[]');
            const number = document.getElementById('cardNumber').value.trim();
            const name = document.getElementById('cardName').value.trim();
            const expiry = document.getElementById('cardExpiry').value.trim();
            if (!number || !name || !expiry) return;
            cards.push({ number, name, expiry });
            localStorage.setItem('deepend_cards', JSON.stringify(cards));
            this.reset();
            renderCards();
        };
        renderCards();

        // Notification Popup
        function showNotificationPopup() {
            const notifications = [
                { title: 'Order Confirmed', message: 'Your order #12345 has been confirmed!', time: '2 min ago' },
                { title: 'Welcome!', message: 'Thanks for joining DEEPEND Entertainment.', time: '1 day ago' },
                { title: 'Event Reminder', message: 'VR Game Experience starts in 1 hour.', time: '3 days ago' }
            ];
            const modal = document.createElement('div');
            modal.tabIndex = -1;
            modal.style.cssText = `position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.35); z-index: 3000; display: flex; align-items: flex-start; justify-content: flex-end;`;
            modal.innerHTML = `
                <div style=\"margin: 32px 32px 0 0; background: rgba(30,30,34,0.95); border-radius: 18px; box-shadow: 0 8px 32px rgba(0,0,0,0.35); min-width: 340px; max-width: 95vw; color: #fff; padding: 1.5rem 1.2rem; border: 1.5px solid rgba(255,255,255,0.08); backdrop-filter: blur(14px);\">
                    <div style='display:flex;align-items:center;justify-content:space-between;margin-bottom:1.1rem;'>
                        <h5 style='margin:0;font-size:1.15rem;font-weight:700;letter-spacing:0.2px;'><i class=\"fa-regular fa-bell\" style=\"color:#FF3B30;margin-right:0.5rem;\"></i>Notifications</h5>
                        <button id='closeNotifModal' style='background:none;border:none;color:#fff;font-size:1.5rem;cursor:pointer;'>&times;</button>
                    </div>
                    <div id='notifList'>
                        ${notifications.map(n => `
                            <div style='margin-bottom:1.1rem;padding-bottom:0.7rem;border-bottom:1px solid rgba(255,255,255,0.07);'>
                                <div style='font-weight:600;font-size:1.04rem;'>${n.title}</div>
                                <div style='color:#bbb;font-size:0.98rem;margin:0.2rem 0 0.3rem 0;'>${n.message}</div>
                                <div style='color:#FF3B30;font-size:0.92rem;'>${n.time}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            modal.focus();
            document.getElementById('closeNotifModal').onclick = () => modal.remove();
            modal.addEventListener('keydown', function(e) { if (e.key === 'Escape') modal.remove(); });
            modal.onclick = function(e) { if (e.target === modal) modal.remove(); };
        }
        document.addEventListener('DOMContentLoaded', function() {
            const notifIcon = document.querySelector('.notification-icon');
            if (notifIcon) notifIcon.onclick = showNotificationPopup;
        });
    </script>
</body>
</html> 